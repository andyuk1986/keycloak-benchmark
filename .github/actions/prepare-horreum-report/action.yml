name: Prepare Horreum Report
description: Prepares JSON report before further processing, i.e. creates the JSON with the env data which gets from the configmap.

inputs:
  project:
    description: 'The project namespace.'
    required: true

runs:
  using: composite
  steps:
    - id: prepare-report-file
      name: Create and Prepare Report File
      shell: bash
      # language=bash
      run: |
        output_file_prefix="result-"
        cur_date_iso=$(date --iso-8601=seconds)
        cur_date_iso_compressed=$(date '+%Y%m%d-%H%M%S')
        uuid=$(uuidgen)
        OUTPUT_FILE_NAME="${output_file_prefix}${cur_date_iso_compressed}-${uuid}.json"
        echo "HORREUM_OUTPUT_FILE_NAME=$OUTPUT_FILE_NAME" >> $GITHUB_ENV
        jq -n --arg current_date "${cur_date_iso}" --arg id "${uuid}" \
        '{"$schema": "urn:keycloak-benchmark:0.1", "uuid": ($id), "name": "ROSA Scalability Benchmark Run Results",
        "start_dttm": ($current_date)}' > ${OUTPUT_FILE_NAME}
        #Reading configmap with environment data
        configJson=$(oc get configmap env-config -n ${{ env.PROJECT }} -o "jsonpath={ .data['environment_data\.json']}'" | rev | cut -d\' -f2- | rev | jq)
        jq '. + {"context":{}}' ${OUTPUT_FILE_NAME} > tmp.json && \
        mv tmp.json ${OUTPUT_FILE_NAME}
        #Putting environment parameters into JSON
        jq --argjson configJson "${configJson}" '.context = ($configJson)' ${OUTPUT_FILE_NAME} > tmp.json && \
        mv tmp.json ${OUTPUT_FILE_NAME}
